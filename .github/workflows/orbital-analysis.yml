name: Orbital analysis (xTB) on extracted cluster

on:
  push:
    paths:
      - "scripts/orbital_analysis_xtb_cluster.py"
      - ".github/workflows/orbital-analysis.yml"
  workflow_dispatch:
    inputs:
      site:
        description: "Adsorption site label (e.g. o69)"
        required: true
        default: "o69"
      cluster_workflow_name:
        description: "Name of the cluster extraction workflow (as shown in Actions UI)"
        required: true
        default: "Cluster extraction"
      cluster_run_id:
        description: "Optional: specific cluster-extraction run ID to download from (leave blank for latest successful)"
        required: false
        default: ""
      artifact_name_prefix:
        description: "Artifact name prefix used by cluster extraction workflow"
        required: true
        default: "cluster"
      charge:
        description: "Cluster total charge (integer)"
        required: true
        default: "0"
      uhf:
        description: "Unpaired electrons (integer; 0 = closed shell)"
        required: true
        default: "0"
      shell_cutoff:
        description: "Neighbor shell cutoff around H* (Ã…)"
        required: true
        default: "3.0"
      frontier_window_ev:
        description: "Energy window around HOMO for active-orbital suggestion (eV)"
        required: true
        default: "2.0"
      topn:
        description: "Max orbitals to suggest"
        required: true
        default: "12"

permissions:
  contents: read
  actions: read

jobs:
  orbital-analysis:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        case:
          - name: neutral
            charge: "0"
            uhf: "0"
          - name: anion
            charge: "-1"
            uhf: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install micromamba
        uses: mamba-org/setup-micromamba@v2
        with:
          micromamba-version: "latest"
          environment-name: iro2
          create-args: >-
            -c conda-forge
            python=3.11
            xtb
            ase
            numpy

      - name: Resolve cluster extraction run id
        id: resolve
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          if [ -n "${{ inputs.cluster_run_id }}" ]; then
            echo "run_id=${{ inputs.cluster_run_id }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          WF="${{ inputs.cluster_workflow_name }}"
          BR="${GITHUB_REF_NAME}"

          RID="$(gh run list \
            --workflow "$WF" \
            --branch "$BR" \
            --status success \
            --limit 20 \
            --json databaseId \
            --jq '.[0].databaseId')"

          if [ -z "${RID}" ] || [ "${RID}" = "null" ]; then
            echo "No successful runs found for workflow '${WF}' on branch '${BR}'"
            exit 1
          fi

          echo "Using latest successful cluster extraction run id: ${RID}"
          echo "run_id=${RID}" >> "$GITHUB_OUTPUT"

      - name: Download cluster artifacts (no name filter)
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mkdir -p artifacts

          RID="${{ steps.resolve.outputs.run_id }}"
          echo "Downloading ALL artifacts from run id ${RID}"
          gh run download "${RID}" -D artifacts

          echo "Downloaded files:"
          find artifacts -maxdepth 4 -type f -print
      
      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail
          echo "site='${{ inputs.site }}'"
          echo "prefix='${{ inputs.artifact_name_prefix }}'"

          if [ -z "${{ inputs.site }}" ]; then
            echo "ERROR: inputs.site is empty. Set it when dispatching (e.g. o69)."
            exit 1
          fi

          if [ -z "${{ inputs.artifact_name_prefix }}" ]; then
            echo "ERROR: inputs.artifact_name_prefix is empty. Set it (e.g. cluster)."
            exit 1
          fi


      - name: Locate cluster geometry file
        id: locate
        shell: bash
        run: |
          set -euo pipefail

          # Preferred filenames
          PREFERRED_TRAJ="$(find artifacts -type f -name "o69_cluster.traj" | head -n 1 || true)"
          PREFERRED_XYZ="$(find artifacts -type f -name "o69_cluster.xyz"  | head -n 1 || true)"

          if [ -n "$PREFERRED_TRAJ" ]; then
            echo "cluster_path=$PREFERRED_TRAJ" >> "$GITHUB_OUTPUT"
            echo "Using cluster traj: $PREFERRED_TRAJ"
            exit 0
          fi

          if [ -n "$PREFERRED_XYZ" ]; then
            echo "cluster_path=$PREFERRED_XYZ" >> "$GITHUB_OUTPUT"
            echo "Using cluster xyz: $PREFERRED_XYZ"
            exit 0
          fi

          # Fallback: any traj/xyz
          TRAJ="$(find artifacts -type f -name "*.traj" | head -n 1 || true)"
          XYZ="$(find artifacts -type f -name "*.xyz"  | head -n 1 || true)"

          if [ -n "$TRAJ" ]; then
            echo "cluster_path=$TRAJ" >> "$GITHUB_OUTPUT"
            echo "Using fallback traj: $TRAJ"
          elif [ -n "$XYZ" ]; then
            echo "cluster_path=$XYZ" >> "$GITHUB_OUTPUT"
            echo "Using fallback xyz: $XYZ"
          else
            echo "No cluster geometry file found in artifacts."
            exit 1
          fi
          
      - name: Run orbital analysis (${{ matrix.case.name }})
        shell: bash
        run: |
          set -euo pipefail
          micromamba run -n iro2 python scripts/orbital_analysis_xtb_cluster.py \
            "${{ steps.locate.outputs.cluster_path }}" \
            --site "${{ inputs.site }}" \
            --charge "${{ matrix.case.charge }}" \
            --uhf "${{ matrix.case.uhf }}" \
            --shell-cutoff "${{ inputs.shell_cutoff }}" \
            --frontier-window-ev "${{ inputs.frontier_window_ev }}" \
            --topn "${{ inputs.topn }}" \
            --outdir "outputs/orbital_analysis/${{ matrix.case.name }}"

      - name: Upload orbital analysis outputs (${{ matrix.case.name }})
        uses: actions/upload-artifact@v4
        with:
          name: orbital-${{ inputs.site }}-${{ matrix.case.name }}
          path: |
            outputs/orbital_analysis/${{ matrix.case.name }}/${{ inputs.site }}/orbitals.csv
            outputs/orbital_analysis/${{ matrix.case.name }}/${{ inputs.site }}/active_orbitals.json
            outputs/orbital_analysis/${{ matrix.case.name }}/${{ inputs.site }}/orbital_report.md
            outputs/orbital_analysis/${{ matrix.case.name }}/${{ inputs.site }}/xtb_sp/molden.input
            outputs/orbital_analysis/${{ matrix.case.name }}/${{ inputs.site }}/xtb_sp/xtb.out
            outputs/orbital_analysis/${{ matrix.case.name }}/${{ inputs.site }}/xtb_sp/xtb.err

