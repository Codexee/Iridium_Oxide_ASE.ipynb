name: Orbital analysis (xTB) on extracted cluster

on:
  workflow_dispatch:
    inputs:
      site:
        description: "Adsorption site label (e.g. o69)"
        required: true
        default: "o69"
      cluster_workflow_name:
        description: "Exact name of the cluster extraction workflow (as shown in Actions UI)"
        required: true
        default: "Cluster extraction"
      cluster_run_id:
        description: "Optional: specific cluster-extraction run ID to download from (leave blank for latest successful)"
        required: false
        default: ""
      shell_cutoff:
        description: "Neighbor shell cutoff around H* (Ã…)"
        required: true
        default: "3.0"
      frontier_window_ev:
        description: "Energy window around HOMO for active-orbital suggestion (eV)"
        required: true
        default: "2.0"
      topn:
        description: "Max orbitals to suggest"
        required: true
        default: "12"

permissions:
  contents: read
  actions: read

jobs:
  orbital-analysis:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        case:
          - name: neutral
            charge: "0"
            uhf: "0"
          - name: anion
            charge: "-1"
            uhf: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install micromamba (xTB + Python deps)
        uses: mamba-org/setup-micromamba@v2
        with:
          micromamba-version: "latest"
          environment-name: iro2
          create-args: >-
            -c conda-forge
            python=3.11
            xtb
            ase
            numpy

      - name: Resolve cluster extraction run id
        id: resolve
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          if [ -n "${{ inputs.cluster_run_id }}" ]; then
            echo "run_id=${{ inputs.cluster_run_id }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          WF="${{ inputs.cluster_workflow_name }}"
          BR="${GITHUB_REF_NAME}"

          RID="$(gh run list \
            --workflow "$WF" \
            --branch "$BR" \
            --status success \
            --limit 20 \
            --json databaseId \
            --jq '.[0].databaseId')"

          if [ -z "${RID}" ] || [ "${RID}" = "null" ]; then
            echo "No successful runs found for workflow '${WF}' on branch '${BR}'"
            exit 1
          fi

          echo "Using latest successful cluster extraction run id: ${RID}"
          echo "run_id=${RID}" >> "$GITHUB_OUTPUT"

      - name: Download ALL cluster artifacts from that run
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mkdir -p artifacts
          RID="${{ steps.resolve.outputs.run_id }}"

          echo "Downloading all artifacts from run id: ${RID}"
          gh run download "${RID}" -D artifacts

          echo "Downloaded files:"
          find artifacts -maxdepth 5 -type f -print

      - name: Locate cluster geometry file
        id: locate
        shell: bash
        run: |
          set -euo pipefail

          SITE="${{ inputs.site }}"

          # Prefer the expected filenames
          PREFERRED_TRAJ="$(find artifacts -type f -name "${SITE}_cluster.traj" | head -n 1 || true)"
          PREFERRED_XYZ="$(find artifacts -type f -name "${SITE}_cluster.xyz"  | head -n 1 || true)"

          if [ -n "$PREFERRED_TRAJ" ]; then
            echo "cluster_path=$PREFERRED_TRAJ" >> "$GITHUB_OUTPUT"
            echo "Using cluster traj: $PREFERRED_TRAJ"
            exit 0
          fi

          if [ -n "$PREFERRED_XYZ" ]; then
            echo "cluster_path=$PREFERRED_XYZ" >> "$GITHUB_OUTPUT"
            echo "Using cluster xyz: $PREFERRED_XYZ"
            exit 0
          fi

          echo "ERROR: Could not find ${SITE}_cluster.traj or ${SITE}_cluster.xyz in downloaded artifacts."
          echo "Here are available traj/xyz files:"
          find artifacts -type f \( -name "*.traj" -o -name "*.xyz" \) -print || true
          exit 1

      - name: Run orbital analysis (${{ matrix.case.name }})
        shell: bash
        run: |
          set -euo pipefail

          echo "Cluster path: ${{ steps.locate.outputs.cluster_path }}"
          echo "Case: ${{ matrix.case.name }} (charge=${{ matrix.case.charge }}, uhf=${{ matrix.case.uhf }})"

          micromamba run -n iro2 python scripts/orbital_analysis_xtb_cluster.py \
            "${{ steps.locate.outputs.cluster_path }}" \
            --site "${{ inputs.site }}" \
            --charge "${{ matrix.case.charge }}" \
            --uhf "${{ matrix.case.uhf }}" \
            --shell-cutoff "${{ inputs.shell_cutoff }}" \
            --frontier-window-ev "${{ inputs.frontier_window_ev }}" \
            --topn "${{ inputs.topn }}" \
            --outdir "outputs/orbital_analysis/${{ matrix.case.name }}"

          echo "Analysis outputs:"
          find "outputs/orbital_analysis/${{ matrix.case.name }}/${{ inputs.site }}" -maxdepth 3 -type f -print

      - name: Upload orbital analysis outputs (${{ matrix.case.name }})
        uses: actions/upload-artifact@v4
        with:
          name: orbital-${{ inputs.site }}-${{ matrix.case.name }}
          path: |
            outputs/orbital_analysis/${{ matrix.case.name }}/${{ inputs.site }}/orbitals.csv
            outputs/orbital_analysis/${{ matrix.case.name }}/${{ inputs.site }}/active_orbitals.json
            outputs/orbital_analysis/${{ matrix.case.name }}/${{ inputs.site }}/orbital_report.md
            outputs/orbital_analysis/${{ matrix.case.name }}/${{ inputs.site }}/xtb_sp/molden.input
            outputs/orbital_analysis/${{ matrix.case.name }}/${{ inputs.site }}/xtb_sp/xtb.out
            outputs/orbital_analysis/${{ matrix.case.name }}/${{ inputs.site }}/xtb_sp/xtb.err
