name: Extract quantum cluster (manual)

on:
  workflow_dispatch:
    inputs:
      site:
        description: "Site index (e.g. 69)"
        required: true
        default: "69"
      cutoff:
        description: "Cutoff radius in Ã…"
        required: true
        default: "6.0"

permissions:
  contents: read
  actions: read
  
jobs:
  extract-cluster:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          auto-activate: false

      - name: Create conda environment
        shell: bash -l {0}
        run: |
          set -euo pipefail
          conda env create -f environment.yml || true
          conda run -n iro2 python -c "import numpy, ase; print('env ok')"

      - name: Download optimization artifact for this site (from latest successful optimize run)
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          # Adjust this to the exact workflow name of your optimization pipeline (as shown in the Actions tab)
          OPT_WORKFLOW_NAME="IrO2 CI (states + manual optimize)"

          RUN_ID="$(gh run list \
            --workflow "$OPT_WORKFLOW_NAME" \
            --branch "${GITHUB_REF_NAME}" \
            --status success \
            --limit 20 \
            --json databaseId \
            --jq '.[0].databaseId')"

          if [ -z "${RUN_ID}" ] || [ "${RUN_ID}" = "null" ]; then
            echo "No successful runs found for workflow: ${OPT_WORKFLOW_NAME} on branch ${GITHUB_REF_NAME}"
            exit 1
          fi

          echo "Using optimize workflow run id: ${RUN_ID}"
          mkdir -p opt
          gh run download "${RUN_ID}" -n "opt-${{ inputs.site }}" -D opt

          echo "Downloaded artifact opt-${{ inputs.site }} into ./opt"


      - name: Locate optimized traj
        shell: bash -l {0}
        run: |
          set -euo pipefail
          echo "Contents:"
          find opt -maxdepth 6 -type f | head -n 200
          FINAL_TRAJ="$(find opt -name "*_final.traj" | head -n 1)"
          if [ -z "${FINAL_TRAJ}" ]; then
            echo "No *_final.traj found in artifact opt-${{ inputs.site }}"
            exit 1
          fi
          echo "FINAL_TRAJ=${FINAL_TRAJ}" >> "$GITHUB_ENV"
          echo "Using: ${FINAL_TRAJ}"

      - name: Extract cluster
        shell: bash -l {0}
        run: |
          set -euo pipefail
          conda run -n iro2 python -u scripts/extract_cluster.py \
            --traj "${FINAL_TRAJ}" \
            --center_atom_index ${{ inputs.site }} \
            --cutoff ${{ inputs.cutoff }} \
            --outdir outputs/clusters \
            --tag o${{ inputs.site }}
          ls -la outputs/clusters

      - name: Upload cluster files
        uses: actions/upload-artifact@v4
        with:
          name: cluster-o${{ inputs.site }}
          path: outputs/clusters/*
