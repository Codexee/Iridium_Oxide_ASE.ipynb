name: IrO2 CI

on:
  push:
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  fit-ising:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          environment-file: environment.yml
          activate-environment: iro2
          auto-activate-base: false

      - name: Download latest simulation outputs artifact from previous run
        env:
           GH_TOKEN: ${{ github.token }}
        shell: bash -l {0}
        run: |
          set -euo pipefail

          ART="irO2-simulation-outputs"

          # List recent successful runs and find the first one that contains the artifact
          RUN_IDS=$(gh run list \
            --workflow "python-package-conda.yml" \
            --status success \
            --limit 50 \
            --json databaseId \
            --jq '.[].databaseId')

          FOUND=""
          for RID in $RUN_IDS; do
            if gh api "repos/${GITHUB_REPOSITORY}/actions/runs/${RID}/artifacts" --jq '.artifacts[].name' | grep -qx "$ART"; then
              FOUND="$RID"
              break
            fi
          done

          if [ -z "$FOUND" ]; then
            echo "ERROR: No previous successful run contains artifact '$ART'."
            echo "Trigger the workflow manually (Actions â†’ Run workflow) to generate it once."
            exit 1
          fi

          echo "Found artifact '$ART' in run $FOUND. Downloading..."
          gh run download "$FOUND" --name "$ART" --dir .

          echo "After download, workspace contains:"
          ls -la
          echo "Outputs tree:"
          echo "Repo tree (artifact contents):"
          find . -maxdepth 3 -type f | head -n 200

      - name: Verify artifact contains results JSONs
        shell: bash -l {0}
        run: |
          set -euo pipefail
          echo "Looking for result + metadata JSONs:"
          find . -path "*results*" -name "*_results.json" | head -n 50
          find . -path "*results*" -name "metadata_*.json" | head -n 50


      - name: Build ising_dataset.json from downloaded artifact contents
        shell: bash -l {0}
        run: |
          set -euo pipefail

           # The artifact unpacks into repo root (e.g., batch_centerO20/, results/), not outputs/
          mkdir -p outputs

          python scripts/build_ising_dataset_from_outputs.py \
            --outputs_dir . \
            --out outputs/ising_dataset.json

          echo "Preview dataset:"
          head -n 80 outputs/ising_dataset.json || true


      - name: Run Ising Hamiltonian fit
        shell: bash -l {0}
        run: |
          set -euo pipefail
          mkdir -p fit_outputs
          python scripts/fit_ising_shells.py \
          --dataset outputs/ising_dataset.json \
          --out fit_outputs/ising_fit_out.json \
          --shells 3.2,4.8,6.5 \
          --fmax_filter 0.06


      - name: Upload Ising fit outputs
        uses: actions/upload-artifact@v4
        with:
          name: ising-fit-outputs
          path: fit_outputs/

  simulate-heavy:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          environment-file: environment.yml
          activate-environment: base
          auto-activate-base: true

      - name: Run slab setup + optimizations (manual)
        run: |
          set -euo pipefail
          mkdir -p outputs
          conda run -n base python scripts/iro2_slab_setup.py --batch-nearby-k 8 --center-o-index 20 --outputs outputs
          conda run -n base python scripts/optimization_iro2_test.py outputs/structures/slab_H_o20_ready.traj --output outputs/results
          conda run -n base python scripts/optimization_iro2_3.py --outputs outputs
          find outputs -maxdepth 4 -type f | head -n 200 || true

      - name: Upload simulation outputs
        uses: actions/upload-artifact@v4
        with:
          name: irO2-simulation-outputs
          path: outputs/
