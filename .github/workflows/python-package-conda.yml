name: IrO2 CI (states + manual optimize)

on:
  push:
    paths:
      - "scripts/generate_states.py"
      - "scripts/run_state_optimizations.py"
      - "scripts/optimization_iro2_test.py"
      - "scripts/potential_window.py"
      - "inputs/state_set.json"
      - "inputs/*.in"
      - ".github/workflows/python-package-conda.yml"
      - "environment.yml"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  generate-states:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          auto-activate: false

      - name: Create conda env from environment.yml
        shell: bash -l {0}
        run: |
          set -euo pipefail
          ENV_NAME="$(python -c "import re; 
          lines=open('environment.yml','r',encoding='utf-8').read().splitlines(); 
          name=[re.match(r'^\\s*name:\\s*(\\S+)\\s*$',l).group(1) for l in lines if re.match(r'^\\s*name:\\s*(\\S+)\\s*$',l)]; 
          print(name[0] if name else (_ for _ in ()).throw(SystemExit('No name in environment.yml')))")"
          echo "ENV_NAME=${ENV_NAME}" >> "$GITHUB_ENV"
          echo "Env name: ${ENV_NAME}"
          conda env list
          if conda env list | awk '{print $1}' | grep -qx "${ENV_NAME}"; then
            echo "Env ${ENV_NAME} already exists"
          else
            conda env create -f environment.yml
          fi
          conda run -n "${ENV_NAME}" python -c "import numpy, ase; print('numpy+ase ok')"

      - name: Generate state structures
        shell: bash -l {0}
        run: |
          set -euo pipefail
          rm -rf outputs || true
          mkdir -p outputs
          conda run -n "${ENV_NAME}" python -u scripts/generate_states.py --state_set inputs/state_set.json --outputs outputs
          echo "Generated files:"
          find outputs/states -maxdepth 5 -type f | head -n 200

      - name: Upload generated states
        uses: actions/upload-artifact@v4
        with:
          name: generated-states
          path: outputs/states/

  optimize-and-analyze:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    needs: generate-states
    steps:
      - uses: actions/checkout@v4

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          auto-activate: false

      - name: Create conda env from environment.yml
        shell: bash -l {0}
        run: |
          set -euo pipefail
          ENV_NAME="$(python -c "import re; 
          lines=open('environment.yml','r',encoding='utf-8').read().splitlines(); 
          name=[re.match(r'^\\s*name:\\s*(\\S+)\\s*$',l).group(1) for l in lines if re.match(r'^\\s*name:\\s*(\\S+)\\s*$',l)]; 
          print(name[0] if name else (_ for _ in ()).throw(SystemExit('No name in environment.yml')))")"
          echo "ENV_NAME=${ENV_NAME}" >> "$GITHUB_ENV"
          echo "Env name: ${ENV_NAME}"
          conda env list
          if conda env list | awk '{print $1}' | grep -qx "${ENV_NAME}"; then
            echo "Env ${ENV_NAME} already exists"
          else
            conda env create -f environment.yml
          fi
          conda run -n "${ENV_NAME}" python -c "import numpy, ase; print('numpy+ase ok')"
          conda run -n "${ENV_NAME}" python -c "import xtb; print('xtb ok')"

      - name: Download generated states artifact
        uses: actions/download-artifact@v4
        with:
          name: generated-states
          path: outputs/states/

      - name: Run optimizations sequentially (manual only)
        shell: bash -l {0}
        run: |
            set -euo pipefail

            echo "ENV_NAME=${ENV_NAME}"
            conda info
            conda env list

            echo "Workspace tree (top):"
            ls -la
            echo "States tree:"
            find outputs/states -maxdepth 4 -type d | head -n 200
            echo "Traj files:"
            find outputs/states -name "*.traj" | head -n 200

            echo "Python + package sanity:"
            conda run -n "${ENV_NAME}" python -V
            conda run -n "${ENV_NAME}" python -c "import numpy, ase, xtb; print('imports ok')"

            echo "Dry run (should print commands immediately):"
            conda run -n "${ENV_NAME}" python -u scripts/run_state_optimizations.py --outputs outputs --exclude hydrated --dry_run

            echo "Running real optimizations (streaming output):"
            # Use 'tee' so output is definitely captured in Actions logs and saved to a file
            conda run -n "${ENV_NAME}" python -u scripts/run_state_optimizations.py --outputs outputs --exclude hydrated 2>&1 | tee outputs/optimize.log

      - name: Compute potential window proxy
        shell: bash -l {0}
        run: |
          set -euo pipefail
          conda run -n "${ENV_NAME}" python -u scripts/potential_window.py --state_set inputs/state_set.json --outputs outputs --out outputs/potential_window.json
          echo "Wrote outputs/potential_window.json"
          head -n 60 outputs/potential_window.json || true

      - name: Upload outputs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: optimized-states-and-window
          path: |
            outputs/states/
            outputs/potential_window.json
