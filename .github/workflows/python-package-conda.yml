name: IrO2 CI (states + manual optimize)

on:
  push:
    paths:
      - "scripts/generate_states.py"
      - "scripts/optimization_iro2_test.py"
      - "scripts/potential_window.py"
      - "inputs/state_set.json"
      - "inputs/*.in"
      - ".github/workflows/python-package-conda.yml"
      - "environment.yml"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  generate-states:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          auto-activate: false

      - name: Create conda environment
        shell: bash -l {0}
        run: |
          set -euo pipefail
          conda env create -f environment.yml || true
          conda env list

      - name: Generate states
        shell: bash -l {0}
        run: |
          set -euo pipefail
          rm -rf outputs || true
          mkdir -p outputs
          conda run -n iro2 python -u scripts/generate_states.py \
            --state_set inputs/state_set.json \
            --outputs outputs
          find outputs/states -name "*.traj"

      - name: Upload generated states
        uses: actions/upload-artifact@v4
        with:
          name: generated-states
          path: outputs/states/

  optimize-single:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    needs: generate-states

    strategy:
      fail-fast: false
      matrix:
        site: [21, 22, 23, 44, 46, 47, 69, 71, clean]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          auto-activate: false

      - name: Create conda environment
        shell: bash -l {0}
        run: |
          set -euo pipefail
          conda env create -f environment.yml || true
          conda run -n iro2 python -c "import numpy, ase, xtb; print('env ok')"

      - name: Download generated states
        uses: actions/download-artifact@v4
        with:
          name: generated-states
          path: outputs/states/

      - name: Select structure
        shell: bash -l {0}
        run: |
          set -euo pipefail
          if [ "${{ matrix.site }}" = "clean" ]; then
            TRAJ="outputs/states/clean/structures/slab_clean_ready.traj"
            OUTDIR="outputs/states/clean/results"
          else
            TRAJ="outputs/states/H_star/structures/slab_H_o${{ matrix.site }}_ready.traj"
            OUTDIR="outputs/states/H_star/results"
          fi
          echo "TRAJ=${TRAJ}" >> "$GITHUB_ENV"
          echo "OUTDIR=${OUTDIR}" >> "$GITHUB_ENV"
          ls -l "${TRAJ}"

      - name: Optimize structure
        shell: bash -l {0}
        run: |
          set -euo pipefail
          mkdir -p "${OUTDIR}"
          echo "Optimizing ${TRAJ}"
          timeout 50m conda run -n iro2 python -u scripts/optimization_iro2_test.py \
            "${TRAJ}" --output "${OUTDIR}" || true
          ls -l "${OUTDIR}" || true

      - name: Upload optimization result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: opt-${{ matrix.site }}
          path: outputs/states/**/results/*
