name: IrO2 CI (states + manual optimize)

on:
  push:
    paths:
      - "scripts/generate_states.py"
      - "scripts/run_state_optimizations.py"
      - "scripts/optimization_iro2_test.py"
      - "scripts/potential_window.py"
      - "inputs/state_set.json"
      - "inputs/*.in"
      - ".github/workflows/python-package-conda.yml"
      - "environment.yml"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  generate-states:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          environment-file: environment.yml
          # New flag (auto-activate-base is deprecated)
          auto-activate: false
          # If installer doesn't default to base, force it explicitly
          activate-environment: base

      - name: Generate state structures
        shell: bash -l {0}
        run: |
            set -euo pipefail
            rm -rf outputs || true
            mkdir -p outputs
            conda run -n iro2 python -u scripts/generate_states.py \
              --state_set inputs/state_set.json \
              --outputs outputs
            echo "Generated files:"
            find outputs/states -maxdepth 5 -type f | head -n 200

      - name: Upload generated states
        uses: actions/upload-artifact@v4
        with:
          name: generated-states
          path: outputs/states/

  optimize-and-analyze:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    needs: generate-states

    steps:
      - uses: actions/checkout@v4

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          environment-file: environment.yml
          auto-activate: false
          activate-environment: base

      - name: Download generated states artifact
        uses: actions/download-artifact@v4
        with:
          name: generated-states
          path: outputs/states/

      - name: Run optimizations sequentially (manual only)
        shell: bash -l {0}
        run: |
          set -euo pipefail
          # Run sequentially for reliability; exclude hydrated on first pass if desired
          conda run -n iro2 python -u scripts/run_state_optimizations.py --outputs outputs --exclude hydrated

      - name: Compute potential window proxy
        shell: bash -l {0}
        run: |
          set -euo pipefail
          conda run -n iro2 python -u scripts/potential_window.py \
            --state_set inputs/state_set.json \
            --outputs outputs \
            --out outputs/potential_window.json
          head -n 80 outputs/potential_window.json || true

      - name: Upload outputs even if something fails
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: optimized-states-and-window
          path: |
            outputs/states/
            outputs/potential_window.json
